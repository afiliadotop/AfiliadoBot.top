# ==================== FAVORITES ENDPOINTS ====================

@router.post("/favorites/{item_id}", status_code=201)
async def add_favorite(
    item_id: int,
    current_user: Dict = Depends(get_current_user)
):
    """
    Adiciona produto aos favoritos
    Busca dados do produto da API Shopee e salva
    """
    try:
        supabase = get_supabase_manager()
        
        # Fetch product data from Shopee API
        client = create_shopee_client()
        add_rate_limiting(client)
        
        async with client:
            result = await client.get_products(item_id=item_id, limit=1)
        
        products = result.get("nodes", [])
        if not products:
            raise HTTPException(status_code=404, detail="Produto não encontrado")
        
        product = products[0]
        
        # PRIVACY: Remove commission data for non-admin users
        is_admin = current_user.get("role") == "admin"
        if not is_admin:
            product.pop('commissionRate', None)
            product.pop('commission', None)
            product.pop('sellerCommissionRate', None)
            product.pop('shopeeCommissionRate', None)
        
        # Insert into favorites
        try:
            supabase.client.table('user_favorites').insert({
                'user_id': current_user['id'],
                'item_id': item_id,
                'product_data': product
            }).execute()
            
            logger.info(f"[Favorites] User {current_user['id']} added item {item_id}")
            return {"status": "added", "itemId": item_id}
            
        except Exception as insert_error:
            if "duplicate key" in str(insert_error).lower() or "unique" in str(insert_error).lower():
                raise HTTPException(status_code=409, detail="Produto já está nos favoritos")
            raise
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"[Favorites] Error adding favorite: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.delete("/favorites/{item_id}")
async def remove_favorite(
    item_id: int,
    current_user: Dict = Depends(get_current_user)
):
    """Remove produto dos favoritos"""
    try:
        supabase = get_supabase_manager()
        
        result = supabase.client.table('user_favorites')\
            .delete()\
            .eq('user_id', current_user['id'])\
            .eq('item_id', item_id)\
            .execute()
        
        if not result.data:
            raise HTTPException(status_code=404, detail="Favorito não encontrado")
        
        logger.info(f"[Favorites] User {current_user['id']} removed item {item_id}")
        return {"status": "removed", "itemId": item_id}
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"[Favorites] Error removing favorite: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/favorites")
async def get_favorites(
    current_user: Dict = Depends(get_current_user)
):
    """Lista todos os favoritos do usuário"""
    try:
        supabase = get_supabase_manager()
        
        result = supabase.client.table('user_favorites')\
            .select('*')\
            .eq('user_id', current_user['id'])\
            .order('created_at', desc=True)\
            .execute()
        
        favorites = []
        for fav in result.data:
            product = fav['product_data']
            product['favoriteId'] = fav['id']
            product['favoritedAt'] = fav['created_at']
            favorites.append(product)
        
        logger.info(f"[Favorites] User {current_user['id']} has {len(favorites)} favorites")
        return {
            "favorites": favorites,
            "count": len(favorites)
        }
        
    except Exception as e:
        logger.error(f"[Favorites] Error fetching favorites: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/favorites/check/{item_id}")
async def check_favorite(
    item_id: int,
    current_user: Dict = Depends(get_current_user)
):
    """Verifica se produto está nos favoritos"""
    try:
        supabase = get_supabase_manager()
        
        result = supabase.client.table('user_favorites')\
            .select('id')\
            .eq('user_id', current_user['id'])\
            .eq('item_id', item_id)\
            .execute()
        
        is_favorite = len(result.data) > 0
        
        return {
            "isFavorite": is_favorite,
            "itemId": item_id
        }
        
    except Exception as e:
        logger.error(f"[Favorites] Error checking favorite: {e}")
        raise HTTPException(status_code=500, detail=str(e))

